import React, { useState, useEffect, useCallback } from 'react';
import ChatModal from './ChatModal';

const API_URL = process.env.REACT_APP_API_URL || '/api';

function GamePlay({ playerData, gameContent, progress, setProgress, onComplete }) {
  const [currentQuestion, setCurrentQuestion] = useState(null);
  const [selectedAnswer, setSelectedAnswer] = useState(null);
  const [showResult, setShowResult] = useState(false);
  const [isCorrect, setIsCorrect] = useState(false);
  const [attempts, setAttempts] = useState(0);
  const [showChat, setShowChat] = useState(false);
  const [showAccessCode, setShowAccessCode] = useState(false);

  const currentRoom = gameContent.rooms.find(r => r.id === progress.currentRoom);
  const character = currentRoom ? gameContent.dialogue[currentRoom.character] : null;
  
  // Get questions for current room that haven't been answered
  const roomQuestions = gameContent.questions.filter(
    q => q.room === progress.currentRoom && 
         !progress.questionsAnswered.find(qa => qa.id === q.id)
  );

  const saveProgress = useCallback(async () => {
    try {
      await fetch(`${API_URL}/save`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          playerId: playerData.playerId,
          currentRoom: progress.currentRoom,
          questionsAnswered: progress.questionsAnswered,
          inventory: progress.inventory,
          score: progress.score
        })
      });
    } catch (error) {
      console.error('Failed to save progress:', error);
    }
  }, [progress, playerData.playerId]);

  useEffect(() => {
    if (roomQuestions.length > 0 && !currentQuestion) {
      setCurrentQuestion(roomQuestions[0]);
    }
  }, [roomQuestions, currentQuestion]);

  // Auto-save progress every 30 seconds
  useEffect(() => {
    const interval = setInterval(() => {
      saveProgress();
    }, 30000);
    return () => clearInterval(interval);
  }, [saveProgress]);

  const handleAnswerSelect = (index) => {
    if (!showResult) {
      setSelectedAnswer(index);
    }
  };

  const handleSubmitAnswer = () => {
    if (selectedAnswer === null) return;

    const correct = selectedAnswer === currentQuestion.correct;
    setIsCorrect(correct);
    setShowResult(true);

    if (correct) {
      const points = Math.max(currentQuestion.points - (attempts * 25), 25);
      const newScore = progress.score + points;
      
      const newQuestionsAnswered = [
        ...progress.questionsAnswered,
        { 
          id: currentQuestion.id, 
          correct: true, 
          attempts: attempts + 1,
          points 
        }
      ];

      setProgress({
        ...progress,
        score: newScore,
        questionsAnswered: newQuestionsAnswered
      });

      // Auto advance after showing result
      setTimeout(() => {
        setShowResult(false);
        setSelectedAnswer(null);
        setCurrentQuestion(null);
        setAttempts(0);
        
        // Check if room complete
        const remaining = roomQuestions.filter(
          q => !newQuestionsAnswered.find(qa => qa.id === q.id)
        );
        
        if (remaining.length <= 1) {
          // Room complete - check if game complete
          if (progress.currentRoom === 8) {
            completeGame();
          }
        }
      }, 3000);
    } else {
      setAttempts(attempts + 1);
      setTimeout(() => {
        setShowResult(false);
        setSelectedAnswer(null);
      }, 2000);
    }
  };

  const handleMoveRoom = (direction) => {
    const targetRoom = gameContent.rooms.find(r => r.name === direction);
    if (targetRoom) {
      setProgress({
        ...progress,
        currentRoom: targetRoom.id
      });
      setCurrentQuestion(null);
      setSelectedAnswer(null);
      setShowResult(false);
      setAttempts(0);
      saveProgress();
    }
  };

  const completeGame = async () => {
    const completionTime = Math.floor((Date.now() - progress.startTime) / 1000);
    const minutes = Math.floor(completionTime / 60);
    const seconds = completionTime % 60;
    const timeStr = `${minutes}:${seconds.toString().padStart(2, '0')}`;
    
    // Prompt for initials
    const initials = prompt('ENTER YOUR INITIALS (3 letters):') || 'AAA';
    
    try {
      const res = await fetch(`${API_URL}/complete`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          playerId: playerData.playerId,
          score: progress.score,
          completionTime,
          initials: initials.substring(0, 3).toUpperCase()
        })
      });
      
      const data = await res.json();
      onComplete(data.completionCode, timeStr, initials);
    } catch (error) {
      console.error('Failed to complete game:', error);
    }
  };

  if (!currentRoom) return <div className="loading"></div>;

  // Calculate progress percentage
  const totalQuestions = gameContent.questions.length;
  const answeredQuestions = progress.questionsAnswered.length;
  const progressPercent = (answeredQuestions / totalQuestions) * 100;

  return (
    <div>
      {/* Header with stats */}
      <div className="border-box border-box-amber">
        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
          <div>
            <span className="retro-font">SCORE: {progress.score}</span>
          </div>
          <div>
            <span className="retro-font">ROOM: {currentRoom.name}</span>
          </div>
          <div>
            <button 
              className="retro-button" 
              style={{ padding: '5px 10px', fontSize: '10px' }}
              onClick={() => setShowAccessCode(!showAccessCode)}
            >
              CODE
            </button>
          </div>
        </div>
      </div>

      {showAccessCode && (
        <div className="border-box mt-1 text-center">
          <p className="retro-font">YOUR ACCESS CODE:</p>
          <p className="text-amber" style={{ fontSize: '32px', margin: '10px 0' }}>
            {playerData.accessCode}
          </p>
          <p style={{ fontSize: '16px' }}>Write this down to continue later!</p>
        </div>
      )}

      {/* Progress bar */}
      <div className="progress-bar mt-2">
        <div className="progress-fill" style={{ width: `${progressPercent}%` }}></div>
      </div>
      <p className="text-center mt-1" style={{ fontSize: '16px' }}>
        QUEST PROGRESS: {answeredQuestions}/{totalQuestions}
      </p>

      {/* Room description */}
      <div className="border-box mt-2">
        <p className="retro-font text-amber mb-2">{currentRoom.name}</p>
        <p>{currentRoom.description}</p>
      </div>

      {/* Current question or navigation */}
      {currentQuestion ? (
        <div className="mt-2">
          <div className="border-box">
            <p className="retro-font mb-2">{currentRoom.character} ASKS:</p>
            <p className="mb-2">{currentQuestion.question}</p>
            
            <ul className="option-list mt-2">
              {currentQuestion.options.map((option, index) => (
                <li
                  key={index}
                  className={`option-item ${
                    selectedAnswer === index ? 'selected' : ''
                  } ${
                    showResult && index === currentQuestion.correct ? 'correct' : ''
                  } ${
                    showResult && selectedAnswer === index && !isCorrect ? 'incorrect' : ''
                  }`}
                  onClick={() => handleAnswerSelect(index)}
                >
                  {String.fromCharCode(65 + index)}) {option}
                </li>
              ))}
            </ul>

            {showResult && (
              <div className={`border-box mt-2 ${isCorrect ? 'border-box-amber' : ''}`}>
                <p className="retro-font">
                  {isCorrect ? character?.correct : character?.wrong}
                </p>
                {isCorrect && (
                  <p className="mt-2">{currentQuestion.explanation}</p>
                )}
              </div>
            )}

            {!showResult && (
              <div className="mt-2 text-center">
                <button
                  className="retro-button retro-button-amber"
                  onClick={handleSubmitAnswer}
                  disabled={selectedAnswer === null}
                >
                  SUBMIT ANSWER
                </button>
                <button
                  className="retro-button mt-2"
                  onClick={() => setShowChat(true)}
                >
                  TALK TO C.H.A.T. ðŸ¤–
                </button>
              </div>
            )}
          </div>
        </div>
      ) : (
        <div className="mt-2">
          <div className="border-box text-center">
            <p className="retro-font text-amber mb-2">AREA CLEARED!</p>
            <p className="mb-2">Choose your next destination:</p>
            
            {currentRoom.exits.map((exit, index) => (
              <button
                key={index}
                className="retro-button mt-2"
                onClick={() => handleMoveRoom(exit)}
              >
                â†’ {exit}
              </button>
            ))}
          </div>
        </div>
      )}

      {/* C.H.A.T. Modal */}
      {showChat && currentQuestion && (
        <ChatModal
          questionId={currentQuestion.id}
          questionText={currentQuestion.question}
          userAnswer={selectedAnswer !== null ? currentQuestion.options[selectedAnswer] : null}
          mode={playerData.mode}
          onClose={() => setShowChat(false)}
        />
      )}
    </div>
  );
}

export default GamePlay;
